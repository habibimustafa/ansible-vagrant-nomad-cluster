- name: Initialize ACL
  shell: nomad acl bootstrap -json
  register: nomad_acl

- name: Create acl directory
  file:
    path: "{{ acl_filepath }}"
    state: directory
    mode: 600
  become: true

- name: Copy ACL to file
  copy:
    content: "{{ nomad_acl.stdout }}"
    dest: "{{ acl_filepath }}/acl.json"
    mode: 644
  become: true

- name: Check nomad status
  shell: nomad status
  environment:
    NOMAD_TOKEN: "{{ (nomad_acl.stdout|from_json).SecretID }}"
  register: nomad_status

- debug: var=nomad_status.stdout
