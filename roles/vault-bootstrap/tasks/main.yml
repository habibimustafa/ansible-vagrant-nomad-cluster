- name: Initialize Vault Token
  shell: vault operator init -format=json
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"
  register: vault_tokens
  when: ansible_hostname == play_hosts|first

- set_fact:
    vault_tokens: "{{ hostvars['vault-1'].vault_tokens }}"
  when: ansible_hostname == play_hosts|first

- name: Copy Tokens to file
  copy:
    content: "{{ vault_tokens.stdout }}"
    dest: /home/vagrant/vault_tokens.json
    mode: 0644
    owner: vagrant
    group: vagrant

- name: Auto Unseal
  shell: "vault operator unseal {{ item }}"
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"
  loop: "{{ (vault_tokens.stdout|from_json).unseal_keys_b64[:3] }}"

- name: Put vault token exporter
  template:
    src: script.export-vault-token.j2
    dest: /usr/local/bin/export-vault-token
    mode: 0755

- name: Set vault token
  shell: |
    export-vault-token
    source ~/.bashrc
  become: true
  become_user: vagrant

- name: Check vault status
  shell: vault status
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"
  register: vault_status

- debug: var=vault_status.stdout
