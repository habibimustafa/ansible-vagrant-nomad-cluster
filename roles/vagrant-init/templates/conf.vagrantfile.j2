# -*- mode: ruby -*-
# vi: set ft=ruby :

PUBLIC_KEY = "{{ public_key_path }}"

CONSUL_PREFIX = "consul"
CONSUL_CLUSTER_IPS = [ "{{ consul_clusters|join('\", \"') }}" ]

NOMAD_PREFIX = "nomad"
NOMAD_CLUSTER_IPS = [ "{{ nomad_clusters|join('\", \"') }}" ]

WORKER_PREFIX = "worker"
WORKER_IPS = [ "{{ worker_clusters|join('\", \"') }}" ]

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/bionic64"
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "1024"
    vb.customize ["modifyvm", :id, "--cableconnected1", "on"]
  end

  cluster_ips = CONSUL_CLUSTER_IPS
  cluster_ips.each_with_index do |node_ip, index|
    box_hostname = "#{CONSUL_PREFIX}-#{index+1}"
    config.vm.define box_hostname do |node|
      node.vm.hostname = box_hostname
      node.vm.network "private_network", ip: node_ip

      node.vm.provider "virtualbox" do |vb|
        vb.name = box_hostname
      end

      node.vm.provision "shell" do |s|
        ssh_pub_key = File.readlines(PUBLIC_KEY).first.strip
        s.inline = <<-SHELL
          echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys
          echo #{ssh_pub_key} >> /root/.ssh/authorized_keys
        SHELL
      end
    end
  end

  cluster_ips = NOMAD_CLUSTER_IPS
  cluster_ips.each_with_index do |node_ip, index|
    box_hostname = "#{NOMAD_PREFIX}-#{index+1}"
    config.vm.define box_hostname do |node|
      node.vm.hostname = box_hostname
      node.vm.network "private_network", ip: node_ip

      node.vm.provider "virtualbox" do |vb|
        vb.name = box_hostname
      end

      node.vm.provision "shell" do |s|
        ssh_pub_key = File.readlines(PUBLIC_KEY).first.strip
        s.inline = <<-SHELL
        echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys
        echo #{ssh_pub_key} >> /root/.ssh/authorized_keys
        SHELL
      end
    end
  end

  worker_ips = WORKER_IPS
  worker_ips.each_with_index do |node_ip, index|
    box_hostname = "#{WORKER_PREFIX}-#{index+1}"
    config.vm.define box_hostname do |node|
      node.vm.hostname = box_hostname
      node.vm.network "private_network", ip: node_ip

      node.vm.provider "virtualbox" do |vb|
        vb.name = box_hostname
      end

      node.vm.provision "shell" do |s|
        ssh_pub_key = File.readlines(PUBLIC_KEY).first.strip
        s.inline = <<-SHELL
        echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys
        echo #{ssh_pub_key} >> /root/.ssh/authorized_keys
        SHELL
      end
    end
  end
end
